<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nodinopro - Master Your Learner's Licence</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            position: relative;
            min-height: 90vh;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: flex;
            min-height: 600px;
        }

        .sidebar {
            width: 280px;
            background: #f8f9fa;
            padding: 20px;
            border-right: 2px solid #e0e0e0;
        }

        .content-area {
            flex: 1;
            padding: 40px;
        }

        .progress-section {
            margin-bottom: 30px;
        }

        .progress-section h3 {
            margin-bottom: 15px;
            color: #2a5298;
        }

        .progress-item {
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .progress-green {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }

        .progress-yellow {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .progress-red {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }

        .affiliate-section {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .affiliate-section h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: #2a5298;
            color: white;
        }

        .btn-primary:hover {
            background: #1e3c72;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .login-form, .register-form, .payment-form {
            max-width: 500px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #2a5298;
        }

        .road-sign {
            width: 150px;
            height: 150px;
            border: 4px solid #333;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 15px;
            cursor: pointer;
            transition: transform 0.3s;
            background: white;
            font-size: 13px;
            font-weight: bold;
            text-align: center;
            padding: 15px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
            position: relative;
        }
        
        .road-sign.octagon {
            clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%);
        }
        
        .road-sign.triangle {
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
        }
        
        .road-sign.circle {
            border-radius: 50%;
        }
        
        .road-sign.rectangle {
            border-radius: 8px;
        }
        
        .road-sign.diamond {
            transform: rotate(45deg);
        }
        
        .road-sign.diamond .sign-content {
            transform: rotate(-45deg);
        }

        .road-sign:hover {
            transform: scale(1.05);
        }

        .road-sign.selected {
            border-color: #2a5298;
            background: #e3f2fd;
        }

        .sign-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin: 30px 0;
        }

        .quiz-options {
            margin-top: 20px;
        }

        .quiz-option {
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quiz-option:hover {
            background: #f8f9fa;
            border-color: #2a5298;
        }

        .quiz-option.selected {
            background: #e3f2fd;
            border-color: #2a5298;
        }

        .payment-info {
            background: #fff3cd;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #ffc107;
        }

        .payment-info h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .payment-info p {
            margin: 8px 0;
            line-height: 1.6;
        }

        .footer {
            background: #2a2a2a;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .score-display {
            font-size: 2em;
            text-align: center;
            padding: 20px;
            margin: 20px 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }

        .hidden {
            display: none;
        }

        .assessment-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .assessment-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            cursor: pointer;
            transition: transform 0.3s;
            text-align: center;
        }

        .assessment-card:hover {
            transform: translateY(-5px);
        }

        .assessment-card h3 {
            margin-bottom: 10px;
        }

        .logo {
            font-size: 1.2em;
            font-weight: bold;
            color: #ffd700;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #dc3545;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #28a745;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        .guide-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .guide-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            text-align: center;
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Guide Overlay -->
        <div id="guideOverlay" class="guide-overlay">
            <div class="guide-content">
                <h2>üöó Welcome to Nodinopro!</h2>
                <p style="margin: 20px 0; line-height: 1.6;">Your guided path to mastering the South African Learner's Licence test. We'll take you step-by-step through everything you need to know.</p>
                <button class="btn btn-primary" onclick="startGuidedTour()">Start Guided Tour</button>
            </div>
        </div>

        <div class="header">
            <div class="logo">NODINOPRO</div>
            <h1>Master Your Learner's Licence</h1>
            <p>The Smart Way to Prepare for Your SA Driver's Licence Test</p>
        </div>

        <!-- Login Screen -->
        <div id="loginScreen" class="content-area">
            <h2 style="text-align: center; margin-bottom: 30px;">Welcome Back</h2>
            <div id="loginMessage"></div>
            <div class="login-form">
                <div class="form-group">
                    <label>Cellphone Number</label>
                    <input type="tel" id="loginPhone" placeholder="0xx xxx xxxx">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password">
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-bottom: 15px;" onclick="handleLogin()">Login</button>
                <p style="text-align: center;">Don't have an account? <a href="#" onclick="showRegister()">Register Now</a></p>
            </div>
        </div>

        <!-- Registration Screen -->
        <div id="registerScreen" class="content-area hidden">
            <h2 style="text-align: center; margin-bottom: 30px;">Create Your Account</h2>
            <div id="registerMessage"></div>
            <div class="register-form">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="regName" placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label>Cellphone Number</label>
                    <input type="tel" id="regPhone" placeholder="0xx xxx xxxx">
                </div>
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="regEmail" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="regPassword" placeholder="Create a password">
                </div>
                <div class="form-group">
                    <label>Affiliate Code (Optional)</label>
                    <input type="text" id="affiliateCode" placeholder="Enter referral code if you have one">
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="showPayment()">Proceed to Payment</button>
                <p style="text-align: center; margin-top: 15px;">Already have an account? <a href="#" onclick="showLogin()">Login</a></p>
            </div>
        </div>

        <!-- Payment Screen -->
        <div id="paymentScreen" class="content-area hidden">
            <h2 style="text-align: center; margin-bottom: 30px;">Payment Information</h2>
            <div class="payment-form">
                <div class="payment-info">
                    <h3>Registration Fee: R289.00</h3>
                    <p><strong>Bank:</strong> FNB</p>
                    <p><strong>Account Number:</strong> 63152615523</p>
                    <p><strong>Reference:</strong> Use your cellphone number</p>
                    <p style="margin-top: 15px;"><strong>Important:</strong> After making payment, please send proof of payment to:</p>
                    <p>üì± WhatsApp: 062 801 0124</p>
                    <p>‚úâÔ∏è Email: nodinopro@gmail.com</p>
                </div>
                <div class="form-group">
                    <label>Upload Proof of Payment</label>
                    <input type="file" id="paymentProof" accept="image/*,.pdf">
                </div>
                <div class="form-group">
                    <label>Verification Code (2FA - Sent to your phone)</label>
                    <input type="text" id="verificationCode" placeholder="Enter 6-digit code">
                </div>
                <button class="btn btn-success" style="width: 100%;" onclick="completeRegistration()">Complete Registration</button>
            </div>
        </div>

        <!-- Dashboard Screen -->
        <div id="dashboardScreen" class="main-content hidden">
            <div class="sidebar">
                <div class="progress-section">
                    <h3>Your Learning Path</h3>
                    <div id="progressContainer">
                        <div class="progress-item progress-green" onclick="startAssessment('learn')">
                            <span>üìö Learn Road Signs</span>
                            <strong id="learnProgress">0%</strong>
                        </div>
                        <div class="progress-item progress-yellow" onclick="startAssessment('memory')">
                            <span>üß† Memory Challenge</span>
                            <strong id="memoryProgress">0%</strong>
                        </div>
                        <div class="progress-item progress-red" onclick="startAssessment('missing')">
                            <span>üîç Find Missing Sign</span>
                            <strong id="missingProgress">0%</strong>
                        </div>
                        <div class="progress-item progress-yellow" onclick="startAssessment('quiz')">
                            <span>‚úÖ Practice Quiz</span>
                            <strong id="quizProgress">0%</strong>
                        </div>
                    </div>
                </div>

                <div class="progress-section">
                    <h3>Overall Progress</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="overallProgressBar" style="width: 0%"></div>
                    </div>
                    <p style="text-align: center; font-weight: bold;" id="overallProgressText">0% Complete</p>
                </div>

                <div class="affiliate-section">
                    <h4>üéÅ Refer & Earn</h4>
                    <p style="font-size: 14px; margin-bottom: 10px;">Your unique code:</p>
                    <p style="font-weight: bold; font-size: 18px; color: #1976d2;" id="userAffiliateCode">NODI12345</p>
                    <button class="btn btn-success" style="width: 100%; margin-top: 10px; font-size: 14px;" onclick="copyAffiliateCode()">Copy Code</button>
                    <p style="font-size: 12px; margin-top: 10px; color: #666;">Earn R50 for each referral!</p>
                </div>
            </div>

            <div class="content-area" id="mainContent">
                <h2>Welcome to Your Dashboard, <span id="userName">User</span>!</h2>
                <p style="margin-bottom: 30px; color: #666;">Follow the guided learning path below to master your learner's licence test.</p>
                
                <div class="assessment-types">
                    <div class="assessment-card" onclick="startAssessment('learn')">
                        <h3>üìö Learn Road Signs</h3>
                        <p>Study all South African road signs with descriptions</p>
                        <div class="progress-bar" style="margin-top: 15px;">
                            <div class="progress-fill" id="learnProgressBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="assessment-card" onclick="startAssessment('memory')">
                        <h3>üß† Memory Challenge</h3>
                        <p>Remember the signs you saw in sequence</p>
                        <div class="progress-bar" style="margin-top: 15px;">
                            <div class="progress-fill" id="memoryProgressBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="assessment-card" onclick="startAssessment('missing')">
                        <h3>üîç Find the Missing Sign</h3>
                        <p>Identify which sign wasn't in the sequence</p>
                        <div class="progress-bar" style="margin-top: 15px;">
                            <div class="progress-fill" id="missingProgressBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="assessment-card" onclick="startAssessment('quiz')">
                        <h3>‚úÖ Multiple Choice Quiz</h3>
                        <p>Test your knowledge with quiz questions</p>
                        <div class="progress-bar" style="margin-top: 15px;">
                            <div class="progress-fill" id="quizProgressBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 40px;">
                    <button class="btn btn-primary" onclick="startGuidedLearning()">Start Guided Learning</button>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>&copy; 2024 Nodinopro. All Rights Reserved.</p>
            <p style="font-size: 12px; margin-top: 5px;">South African Learner's Licence Preparation Platform</p>
        </div>
    </div>

    <script>
        // Firebase Configuration - REPLACE WITH YOUR ACTUAL CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyA5iMAkumEn63he362LdlgSlph47PI2M-8",
            authDomain: "nodinopro-f8619.firebaseapp.com",
            databaseURL: "https://nodinopro-f8619-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "nodinopro-f8619",
            storageBucket: "nodinopro-f8619.firebasestorage.app",
            messagingSenderId: "986804565375",
            appId: "1:986804565375:web:3867091cc598f86b56564a"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Application State
        let currentUser = null;
        let userData = null;
        let currentAssessment = null;
        let currentQuestion = 0;
        let score = 0;
        let shownSigns = [];
        let currentStep = 0;

        const roadSigns = [
            {name: 'STOP', type: 'regulatory', color: '#DC143C', shape: 'octagon', textColor: 'white', icon: 'STOP', description: 'Come to complete stop'},
            {name: 'YIELD', type: 'regulatory', color: '#DC143C', shape: 'triangle', textColor: 'white', icon: '‚ö†', description: 'Give way to other vehicles'},
            {name: 'NO ENTRY', type: 'regulatory', color: '#DC143C', shape: 'circle', textColor: 'white', icon: '‚äò', description: 'Do not enter this road'},
            {name: 'SPEED 60', type: 'regulatory', color: '#DC143C', shape: 'circle', textColor: 'white', icon: '60', description: 'Maximum speed 60km/h'},
            {name: 'SPEED 80', type: 'regulatory', color: '#DC143C', shape: 'circle', textColor: 'white', icon: '80', description: 'Maximum speed 80km/h'},
            {name: 'SPEED 120', type: 'regulatory', color: '#DC143C', shape: 'circle', textColor: 'white', icon: '120', description: 'Maximum speed 120km/h'},
            {name: 'ONE WAY', type: 'regulatory', color: '#0047AB', shape: 'rectangle', textColor: 'white', icon: '‚Üí', description: 'One-way traffic only'},
            {name: 'NO PARKING', type: 'regulatory', color: '#DC143C', shape: 'circle', textColor: 'white', icon: 'P', description: 'No parking allowed'},
            {name: 'NO U-TURN', type: 'regulatory', color: '#DC143C', shape: 'circle', textColor: 'white', icon: '‚Ü∂', description: 'U-turns prohibited'},
            {name: 'PED CROSSING', type: 'warning', color: '#FFD700', shape: 'diamond', textColor: 'black', icon: 'üö∂', description: 'Pedestrian crossing ahead'},
            {name: 'CHILDREN', type: 'warning', color: '#FFD700', shape: 'triangle', textColor: 'black', icon: 'üë∂', description: 'Children crossing area'},
            {name: 'CURVE AHEAD', type: 'warning', color: '#FFD700', shape: 'diamond', textColor: 'black', icon: '‚Ü∑', description: 'Curve in road ahead'},
            {name: 'T-JUNCTION', type: 'warning', color: '#FFD700', shape: 'triangle', textColor: 'black', icon: '‚ä§', description: 'T-junction ahead'},
            {name: 'TRAFFIC CIRCLE', type: 'warning', color: '#FFD700', shape: 'triangle', textColor: 'black', icon: '‚ü≤', description: 'Roundabout ahead'},
            {name: 'SLIPPERY ROAD', type: 'warning', color: '#FFD700', shape: 'triangle', textColor: 'black', icon: 'üåä', description: 'Slippery road conditions'},
            {name: 'NARROW BRIDGE', type: 'warning', color: '#FFD700', shape: 'triangle', textColor: 'black', icon: '‚´¥', description: 'Narrow bridge ahead'},
            {name: 'RAILWAY', type: 'warning', color: '#FFD700', shape: 'triangle', textColor: 'black', icon: 'üöÇ', description: 'Railway crossing ahead'},
            {name: 'HOSPITAL', type: 'information', color: '#0047AB', shape: 'rectangle', textColor: 'white', icon: 'H', description: 'Hospital nearby'},
            {name: 'PARKING', type: 'information', color: '#0047AB', shape: 'rectangle', textColor: 'white', icon: 'P', description: 'Parking area'},
            {name: 'RESTAURANT', type: 'information', color: '#0047AB', shape: 'rectangle', textColor: 'white', icon: 'üç¥', description: 'Restaurant facilities'},
            {name: 'PETROL', type: 'information', color: '#0047AB', shape: 'rectangle', textColor: 'white', icon: '‚õΩ', description: 'Petrol station ahead'},
            {name: 'REST AREA', type: 'information', color: '#0047AB', shape: 'rectangle', textColor: 'white', icon: '‚òï', description: 'Rest area available'}
        ];

        // Guided Learning Steps
        const learningSteps = [
            { title: "Welcome!", message: "Let's start by learning all the road signs you need to know for your test." },
            { title: "Road Signs", message: "Study each sign carefully. Pay attention to shapes and colors - they indicate the sign type." },
            { title: "Memory Test", message: "Now let's test your memory! Try to remember the sequence of signs shown." },
            { title: "Missing Sign", message: "Can you spot which sign is missing? This tests your observation skills." },
            { title: "Final Quiz", message: "Time for the practice quiz! Answer multiple choice questions about road signs." }
        ];

        // Initialize Application
        function initApp() {
            // Check if user is already logged in
            auth.onAuthStateChanged((user) => {
                if (user) {
                    loadUserData(user.uid);
                } else {
                    showLogin();
                }
            });
        }

        // Authentication Functions
        async function handleLogin() {
            const phone = document.getElementById('loginPhone').value;
            const password = document.getElementById('loginPassword').value;
            const messageDiv = document.getElementById('loginMessage');

            if (!phone || !password) {
                showMessage('Please enter your phone number and password', 'error', messageDiv);
                return;
            }

            try {
                // For demo purposes - in production, use Firebase Auth with phone/email
                const userCredential = await auth.signInWithEmailAndPassword(phone + '@nodinopro.com', password);
                currentUser = userCredential.user;
                showMessage('Login successful!', 'success', messageDiv);
                setTimeout(() => loadUserData(currentUser.uid), 1000);
            } catch (error) {
                showMessage('Login failed. Please check your credentials.', 'error', messageDiv);
            }
        }

        async function completeRegistration() {
            const verificationCode = document.getElementById('verificationCode').value;
            const paymentProof = document.getElementById('paymentProof').files[0];

            if (!verificationCode) {
                alert('Please enter a verification code (you can use any 6-digit number for testing)');
                return;
            }

            try {
                const name = document.getElementById('regName').value;
                const phone = document.getElementById('regPhone').value;
                const email = document.getElementById('regEmail').value;
                const password = document.getElementById('regPassword').value;

                // Create user account
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                currentUser = userCredential.user;

                // Save user data to Firestore
                await db.collection('users').doc(currentUser.uid).set({
                    name: name,
                    phone: phone,
                    email: email,
                    affiliateCode: 'NODI' + Math.floor(10000 + Math.random() * 90000),
                    progress: {
                        learn: 0,
                        memory: 0,
                        missing: 0,
                        quiz: 0,
                        overall: 0
                    },
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'active'
                });

                alert('‚úÖ Registration successful! Your account is now active. Welcome to Nodinopro!');
                loadUserData(currentUser.uid);
            } catch (error) {
                alert('Registration failed: ' + error.message);
            }
        }

        async function loadUserData(uid) {
            try {
                const doc = await db.collection('users').doc(uid).get();
                if (doc.exists) {
                    userData = doc.data();
                    showDashboard();
                    updateProgressBars();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // UI Navigation Functions
        function showLogin() {
            hideAllScreens();
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        function showRegister() {
            hideAllScreens();
            document.getElementById('registerScreen').classList.remove('hidden');
        }

        function showPayment() {
            const name = document.getElementById('regName').value;
            const phone = document.getElementById('regPhone').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;

            if (!name || !phone || !email || !password) {
                alert('Please fill in all required fields');
                return;
            }

            hideAllScreens();
            document.getElementById('paymentScreen').classList.remove('hidden');
            
            alert('A 6-digit verification code has been sent to your phone via SMS');
        }

        function showDashboard() {
            hideAllScreens();
            document.getElementById('dashboardScreen').classList.remove('hidden');
            
            if (userData) {
                document.getElementById('userName').textContent = userData.name;
                document.getElementById('userAffiliateCode').textContent = userData.affiliateCode;
            }
        }

        function hideAllScreens() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('registerScreen').classList.add('hidden');
            document.getElementById('paymentScreen').classList.add('hidden');
            document.getElementById('dashboardScreen').classList.add('hidden');
        }

        // Progress Tracking
        async function updateProgress(module, percentage) {
            if (!userData || !currentUser) return;

            try {
                userData.progress[module] = Math.max(userData.progress[module], percentage);
                
                // Calculate overall progress
                const progresses = Object.values(userData.progress).filter(val => typeof val === 'number');
                userData.progress.overall = Math.round(progresses.reduce((a, b) => a + b, 0) / progresses.length);

                await db.collection('users').doc(currentUser.uid).update({
                    progress: userData.progress
                });

                updateProgressBars();
            } catch (error) {
                console.error('Error updating progress:', error);
            }
        }

        function updateProgressBars() {
            if (!userData) return;

            const progress = userData.progress;
            
            // Update percentage displays
            document.getElementById('learnProgress').textContent = progress.learn + '%';
            document.getElementById('memoryProgress').textContent = progress.memory + '%';
            document.getElementById('missingProgress').textContent = progress.missing + '%';
            document.getElementById('quizProgress').textContent = progress.quiz + '%';
            
            // Update progress bars
            document.getElementById('learnProgressBar').style.width = progress.learn + '%';
            document.getElementById('memoryProgressBar').style.width = progress.memory + '%';
            document.getElementById('missingProgressBar').style.width = progress.missing + '%';
            document.getElementById('quizProgressBar').style.width = progress.quiz + '%';
            document.getElementById('overallProgressBar').style.width = progress.overall + '%';
            document.getElementById('overallProgressText').textContent = progress.overall + '% Complete';
        }

        // Guided Learning Functions
        function startGuidedTour() {
            document.getElementById('guideOverlay').classList.add('hidden');
            showRegister();
        }

        function startGuidedLearning() {
            currentStep = 0;
            showNextLearningStep();
        }

        function showNextLearningStep() {
            if (currentStep >= learningSteps.length) {
                startAssessment('learn');
                return;
            }

            const step = learningSteps[currentStep];
            const content = document.getElementById('mainContent');
            
            content.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <h2>${step.title}</h2>
                    <p style="font-size: 1.2em; margin: 30px 0; line-height: 1.6;">${step.message}</p>
                    <div class="navigation-buttons">
                        ${currentStep > 0 ? '<button class="btn btn-secondary" onclick="currentStep--; showNextLearningStep()">Previous</button>' : '<div></div>'}
                        <button class="btn btn-primary" onclick="currentStep++; showNextLearningStep()">
                            ${currentStep === learningSteps.length - 1 ? 'Start Learning' : 'Continue'}
                        </button>
                    </div>
                </div>
            `;
        }

        // Assessment Functions (same as before, but with progress tracking)
        function startAssessment(type) {
            currentAssessment = type;
            currentQuestion = 0;
            score = 0;
            const content = document.getElementById('mainContent');

            if (type === 'learn') {
                showLearningMode(content);
            } else if (type === 'memory') {
                showMemoryChallenge(content);
            } else if (type === 'missing') {
                showMissingSignTest(content);
            } else if (type === 'quiz') {
                showMultipleChoiceQuiz(content);
            }
        }

        function showLearningMode(content) {
            let html = '<h2>üìö Learn Road Signs</h2>';
            html += '<p style="margin-bottom: 30px;">Study these South African road signs carefully. Click on any sign to learn more.</p>';
            html += '<div class="sign-grid">';
            
            roadSigns.forEach(sign => {
                html += `<div class="road-sign ${sign.shape}" style="background: ${sign.color}; border-color: ${sign.shape === 'triangle' || sign.shape === 'diamond' ? '#000' : sign.color}; color: ${sign.textColor};" onclick="alert('${sign.description}')">
                    <div class="sign-content" style="font-size: ${sign.icon.length > 3 ? '16px' : '36px'}; line-height: 1.2;">
                        ${sign.icon}<br>
                        <span style="font-size: 11px; margin-top: 5px; display: block;">${sign.name}</span>
                    </div>
                </div>`;
            });
            
            html += '</div>';
            html += '<div style="text-align: center; margin-top: 30px;">';
            html += '<button class="btn btn-primary" onclick="updateProgress(\'learn\', 100); startAssessment(\'memory\')">I\'ve Learned These Signs</button>';
            html += '</div>';
            content.innerHTML = html;
        }

        function showMemoryChallenge(content) {
            shownSigns = [];
            for (let i = 0; i < 5; i++) {
                shownSigns.push(roadSigns[Math.floor(Math.random() * roadSigns.length)]);
            }

            let html = '<h2>üß† Memory Challenge</h2>';
            html += '<p>Study these 5 signs for 10 seconds...</p>';
            html += '<div class="sign-grid">';
            
            shownSigns.forEach(sign => {
                html += `<div class="road-sign ${sign.shape}" style="background: ${sign.color}; border-color: ${sign.shape === 'triangle' || sign.shape === 'diamond' ? '#000' : sign.color}; color: ${sign.textColor};">
                    <div class="sign-content" style="font-size: ${sign.icon.length > 3 ? '16px' : '36px'};">
                        ${sign.icon}<br>
                        <span style="font-size: 11px; margin-top: 5px; display: block;">${sign.name}</span>
                    </div>
                </div>`;
            });
            
            html += '</div>';
            content.innerHTML = html;

            setTimeout(() => {
                askMemoryQuestion(content);
            }, 10000);
        }

        function askMemoryQuestion(content) {
            const allSigns = [...roadSigns];
            const options = [...shownSigns.slice(0, 3)];
            const notShown = allSigns.filter(s => !shownSigns.includes(s));
            options.push(notShown[Math.floor(Math.random() * notShown.length)]);
            options.sort(() => Math.random() - 0.5);

            let html = '<h2>Which sign did you see?</h2>';
            html += '<div class="quiz-options">';
            
            options.forEach((sign, idx) => {
                html += `<div class="quiz-option" onclick="checkMemoryAnswer('${sign.name}', ${shownSigns.some(s => s.name === sign.name)})">${sign.name}</div>`;
            });
            
            html += '</div>';
            content.innerHTML = html;
        }

        function checkMemoryAnswer(answer, isCorrect) {
            if (isCorrect) {
                score += 10;
                alert('Correct! Well done!');
                updateProgress('memory', Math.min(100, userData.progress.memory + 25));
            } else {
                alert('Incorrect. Study the signs again.');
            }
            startAssessment('memory');
        }

        function showMissingSignTest(content) {
            shownSigns = [];
            for (let i = 0; i < 5; i++) {
                shownSigns.push(roadSigns[Math.floor(Math.random() * roadSigns.length)]);
            }

            let html = '<h2>üîç Find the Missing Sign</h2>';
            html += '<p>Remember these 5 signs...</p>';
            html += '<div class="sign-grid">';
            
            shownSigns.forEach(sign => {
                html += `<div class="road-sign ${sign.shape}" style="background: ${sign.color}; border-color: ${sign.shape === 'triangle' || sign.shape === 'diamond' ? '#000' : sign.color}; color: ${sign.textColor};">
                    <div class="sign-content" style="font-size: ${sign.icon.length > 3 ? '16px' : '36px'};">
                        ${sign.icon}<br>
                        <span style="font-size: 11px; margin-top: 5px; display: block;">${sign.name}</span>
                    </div>
                </div>`;
            });
            
            html += '</div>';
            content.innerHTML = html;

            setTimeout(() => {
                askMissingSignQuestion(content);
            }, 8000);
        }

        function askMissingSignQuestion(content) {
            const removedSign = shownSigns[Math.floor(Math.random() * shownSigns.length)];
            const displaySigns = shownSigns.filter(s => s !== removedSign);

            let html = '<h2>Which sign is missing?</h2>';
            html += '<p>One sign has been removed. Can you identify it?</p>';
            html += '<div class="sign-grid">';
            
            displaySigns.forEach(sign => {
                html += `<div class="road-sign ${sign.shape}" style="background: ${sign.color}; border-color: ${sign.shape === 'triangle' || sign.shape === 'diamond' ? '#000' : sign.color}; color: ${sign.textColor};">
                    <div class="sign-content" style="font-size: ${sign.icon.length > 3 ? '16px' : '36px'};">
                        ${sign.icon}<br>
                        <span style="font-size: 11px; margin-top: 5px; display: block;">${sign.name}</span>
                    </div>
                </div>`;
            });
            
            html += '</div>';
            html += '<div class="quiz-options">';
            
            const options = [...shownSigns].sort(() => Math.random() - 0.5);
            options.forEach(sign => {
                html += `<div class="quiz-option" onclick="checkMissingAnswer('${sign.name}', '${removedSign.name}')">${sign.name}</div>`;
            });
            
            html += '</div>';
            content.innerHTML = html;
        }

        function checkMissingAnswer(answer, correct) {
            if (answer === correct) {
                score += 15;
                alert('Excellent! You found the missing sign!');
                updateProgress('missing', Math.min(100, userData.progress.missing + 25));
            } else {
                alert('Not quite. The missing sign was: ' + correct);
            }
            startAssessment('missing');
        }

        function showMultipleChoiceQuiz(content) {
            const sign = roadSigns[Math.floor(Math.random() * roadSigns.length)];
            const wrongAnswers = roadSigns.filter(s => s !== sign).slice(0, 3);
            const options = [sign, ...wrongAnswers].sort(() => Math.random() - 0.5);

            let html = '<h2>‚úÖ Multiple Choice Quiz</h2>';
            html += '<div class="score-display">Score: ' + score + '</div>';
            html += `<div class="road-sign ${sign.shape}" style="background: ${sign.color}; border-color: ${sign.shape === 'triangle' || sign.shape === 'diamond' ? '#000' : sign.color}; color: ${sign.textColor}; width: 200px; height: 200px; font-size: 20px; margin: 30px auto;">
                <div class="sign-content" style="font-size: 48px;">
                    ${sign.icon}<br>
                    <span style="font-size: 14px; margin-top: 10px; display: block;">${sign.name}</span>
                </div>
            </div>`;
            html += '<div class="quiz-options">';
            html += `<div class="quiz-option" onclick="checkQuizAnswer('${sign.description}')">${sign.description}</div>`;
            wrongAnswers.forEach(wrong => {
                html += `<div class="quiz-option" onclick="checkQuizAnswer('${wrong.description}')">${wrong.description}</div>`;
            });
            html += '</div>';
            content.innerHTML = html;
        }

        function checkQuizAnswer(selected) {
            const currentSign = shownSigns[shownSigns.length - 1] || roadSigns[0];
            if (selected === currentSign.description) {
                score += 10;
                alert('Correct! üéâ');
                updateProgress('quiz', Math.min(100, userData.progress.quiz + 20));
            } else {
                alert('Incorrect. The correct answer is: ' + currentSign.description);
            }
            startAssessment('quiz');
        }

        // Utility Functions
        function showMessage(message, type, container) {
            container.innerHTML = `<div class="${type === 'error' ? 'error-message' : 'success-message'}">${message}</div>`;
        }

        function copyAffiliateCode() {
            const code = document.getElementById('userAffiliateCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('Affiliate code copied to clipboard!');
            });
        }

        // Initialize the application when page loads
        window.onload = initApp;
    </script>
</body>
</html>
